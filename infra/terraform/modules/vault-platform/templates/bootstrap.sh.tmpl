#!/usr/bin/env bash
set -euo pipefail

VAULT_ADDR="${VAULT_ADDR:-}"
APPROLE_PATH="${approle_path}"
OUTPUT_DIR="${output_dir}"
ROTATE_SPEC="${rotate_cron}"

if [[ -z "${VAULT_TOKEN:-}" ]]; then
  echo "[vault-bootstrap] VAULT_TOKEN must be exported for bootstrap operations." >&2
  exit 1
fi

mkdir -p "${OUTPUT_DIR}"

echo "[vault-bootstrap] Writing AppRole secrets to ${OUTPUT_DIR}"

%{ for role in manifest ~}
echo " â€¢ ${role.name}"
ROLE_ID="$(vault read -field=role_id ${APPROLE_PATH}/role/${role.name})"
vault write -format=json -f ${APPROLE_PATH}/role/${role.name}/secret-id > "${OUTPUT_DIR}/${role.secret}-secret.json"

cat > "${OUTPUT_DIR}/${role.secret}-env.sh" <<EOF
export VAULT_ROLE_ID="${ROLE_ID}"
export VAULT_SECRET_ID="\$(jq -r '.data.secret_id' "${OUTPUT_DIR}/${role.secret}-secret.json")"
EOF

chmod 600 "${OUTPUT_DIR}/${role.secret}-secret.json" "${OUTPUT_DIR}/${role.secret}-env.sh"
%{ endfor ~}

cat > "${OUTPUT_DIR}/rotate-${namespace}-secrets.sh" <<EOF
#!/usr/bin/env bash
set -euo pipefail

APPROLE_PATH="${APPROLE_PATH}"
OUTPUT_DIR="${OUTPUT_DIR}"

%{ for role in manifest ~}
vault write -format=json -f ${APPROLE_PATH}/role/${role.name}/secret-id > "${OUTPUT_DIR}/${role.secret}-secret.json"
echo "[vault-rotate] Rotated credentials for ${role.name}"
%{ endfor ~}
EOF

chmod +x "${OUTPUT_DIR}/rotate-${namespace}-secrets.sh"

cat <<EOF
[vault-bootstrap] Completed. Add the following cron entry to automate rotation every ${ROTATE_SPEC}:
${ROTATE_SPEC} ${OUTPUT_DIR}/rotate-${namespace}-secrets.sh >> ${OUTPUT_DIR}/rotate.log 2>&1
EOF
