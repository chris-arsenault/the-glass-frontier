groups:
  - name: story-pipeline
    rules:
      - alert: TemporalWorkflowLagHigh
        expr: histogram_quantile(0.95, sum(rate({{ lag_metric }}_bucket[5m])) by (le)) * 1000 > ${latency_target_ms}
        for: 5m
        labels:
          severity: critical
          service: ${alert_label_service}
        annotations:
          summary: "Temporal workflow lag exceeds ${latency_target_ms} ms p95"
          description: "Investigate Temporal workers or check queues for backlog and scale Nomad allocations."
      - alert: StoryConsolidationRetries
        expr: increase(story_consolidation_retry_total[15m]) > 3
        for: 10m
        labels:
          severity: warning
          service: ${alert_label_service}
        annotations:
          summary: "Story consolidation retries spiking"
          description: "Review change feed ingestion for malformed transcripts or Vault credential issues."
