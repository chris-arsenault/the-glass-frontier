"# IMP-HUB-02 – Hub Orchestrator & Temporal Hooks\n+\n+## Summary\n+- Added a sharded `HubOrchestrator` worker that consumes `hub.command` events from the gateway, maintains Redis/in-memory room state caches, and fans out `hub.stateUpdate` payloads.\n+- Extended `HubGateway` with lifecycle events, room broadcast helpers, and connection-scoped sending so orchestrator workers can push snapshots and updates deterministically.\n+- Implemented room state stores (`InMemoryRoomStateStore`, `RedisRoomStateStore`) that manage participants, trades, rituals, and tracker streams for recovery.\n+- Wired Temporal escalation hooks so verbs with check templates trigger `hubActionWorkflow` runs, emitting telemetry for success/failure.\n+- Expanded hub telemetry coverage (`stateUpdated`, `workflowStarted/Failed`, `stateSnapshotSent`, `stateBroadcastFailed`) to surface orchestrator activity.\n+- Authored integration coverage for join/leave flows, trade execution, and Temporal rituals; verified full Jest suite.\n+\n+## Architectural Notes\n+- `HubOrchestrator` shards work by room id hash, keeping per-room command ordering while allowing concurrency across rooms.\n+- Connection lifecycle hooks from `HubGateway` (`connectionOpened/connectionClosed`) feed orchestrator presence refreshes and snapshot delivery.\n+- Room state store abstraction exposes `updateRoomState`, `getRoomState`, and tracker APIs so Redis and in-memory backends share logic.\n+- Temporal integration defers to injected client (`startHubActionWorkflow`) and records workflow metadata back into state for client awareness.\n+- Broadcasts reuse new `HubGateway.broadcastToRoom` helper to deliver state updates to all active connections in a room; `sendToConnection` handles targeted snapshots with backpressure-aware telemetry.\n+\n+## Testing & Verification\n+- `__tests__/integration/hub/hubOrchestrator.integration.test.js`\n+  - Validates trade command ordering/state updates.\n+  - Asserts presence join/reconnect snapshots and leave transitions.\n+  - Confirms Temporal workflow invocation and ritual state persistence.\n+- `npm test` (Jest suite) — ✅\n+\n+## Follow-ups / Risks\n+- Redis-backed room state store currently depends on external Redis client availability; production deployment must supply configured client instances.\n+- Snapshot tests rely on `setImmediate` flushing; future refactor should expose explicit orchestrator idle promises for lifecycle events.\n+- Upcoming work (IMP-HUB-03) should leverage new telemetry hooks for narrative escalation safety dashboards.\n+\n+## References\n+- `src/hub/orchestrator/hubOrchestrator.js`\n+- `src/hub/state/inMemoryRoomStateStore.js`\n+- `src/hub/state/redisRoomStateStore.js`\n+- `src/hub/hubGateway.js`\n+- `src/hub/telemetry/hubTelemetry.js`\n+- `__tests__/integration/hub/hubOrchestrator.integration.test.js`\n*** End Patch
