"# IMP-OFFLINE-04 – Closure Triggered Workflow Orchestration\n+\n+**Backlog Anchor:** IMP-OFFLINE-04 (Closure Triggered Workflow Orchestration)  \n+**Feature:** IMP-OFFLINE – Post-Session Publishing Pipeline  \n+**Design References:** DES-15, REQUIREMENTS.md, prior IMP-GM-05 closure implementation\n+\n+## Summary\n+- Introduced an in-process `ClosureWorkflowOrchestrator` that subscribes to `SessionClosureCoordinator` jobs, runs story consolidation, entity extraction, world delta queueing, and publishing preparation, then updates session state.\n+- Expanded the coordinator to manage job lifecycle metadata (queued → processing → completed/failed), emit telemetry topics, and notify listeners asynchronously.\n+- Extended session memory summaries with offline reconciliation metadata and workflow history so clients/admin dashboards can surface orchestration progress.\n+- Wired the server bootstrap to start the orchestrator automatically and cleanly stop it during shutdown, keeping post-session automation active without Temporal workers.\n+\n+## Implementation Highlights\n+- `src/offline/closureWorkflowOrchestrator.js`: orchestrates closure jobs, sanitises transcripts, triggers orchestrated workflows, records telemetry, and emits admin alerts when failures or SLA breaches occur.\n+- `src/offline/sessionClosureCoordinator.js`: now tracks start/completion timestamps, attempts, results, and supports listener registration for job dispatch while logging telemetry events.\n+- `src/memory/sessionMemory.js`: records offline workflow history, marks reconciliation completion, and ensures `pendingOfflineReconcile` clears once the pipeline finishes.\n+- `src/auth/sessionDirectory.js`: exposes `offlineLastRun` and `offlineReconciledAt` summaries for client dashboards.\n+- `src/server/index.js`: boots the orchestrator alongside the HTTP stack and gracefully stops it on shutdown.\n+\n+## Code Surfaces\n+| Path | Purpose |\n+| --- | --- |\n+| `src/offline/closureWorkflowOrchestrator.js` | Event-driven orchestrator for closure jobs, telemetry, and admin alerting. |\n+| `src/offline/sessionClosureCoordinator.js` | Job queue with lifecycle tracking and listener fan-out. |\n+| `src/memory/sessionMemory.js` | Offline workflow history + reconciliation helpers. |\n+| `src/auth/sessionDirectory.js` | Session summary fields for offline status exposure. |\n+| `src/server/index.js` | Server wiring for the orchestrator lifecycle. |\n+| `src/telemetry/offlineMetrics.js` | Telemetry emitter for `telemetry.offline.workflow.*` topics. |\n+| `__tests__/unit/offline/*.test.js` | Coverage for coordinator lifecycle and orchestration success/failure flows. |\n+\n+## Telemetry & Alerts\n+- Emits `telemetry.offline.workflow.started|completed|failed|latency` for monitoring.\n+- Retains existing `admin.alert` pathways for enqueue failures and adds alerts for orchestration failures or SLA breaches.\n+- Preserves downstream telemetry from story consolidation, publishing, and search sync planners.\n+\n+## Verification\n+- `npm test`\n+- Targeted unit coverage:\n+  - `__tests__/unit/offline/sessionClosureCoordinator.test.js`\n+  - `__tests__/unit/offline/closureWorkflowOrchestrator.test.js`\n+- Existing integration suites (`auth.account`, `app`, `memory.api`) continue to pass.\n+\n+## Follow-Ups\n+1. Swap the in-process orchestrator for Temporal workers once the Temporal deployment lands; reuse metrics topics for parity.\n+2. Persist workflow history to durable storage (PostgreSQL) and expose in admin dashboards.\n+3. Extend entity extraction to incorporate spaCy/NER outputs when available, ensuring orchestrator interfaces remain compatible.\n+4. Hook publishing completion into moderation dashboards once `IMP-MOD` features ship.\n*** End Patch
